<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中秋快乐 · 月圆人圆</title>
  <meta name="description" content="给朋友的中秋节祝福网页" />
  <meta name="theme-color" content="#0b1226" />
  <style>
    :root{
      --bg:#0b1226;         /* 夜空底色 */
      --fg:#e6e9f2;         /* 文字主色 */
      --gold:#ffd166;       /* 金色点缀 */
      --accent:#ff7b89;     /* 粉红灯笼 */
      --accent-2:#ffb703;   /* 橙黄灯笼 */
      --glow:#9ad5ff;       /* 月光 */
      --card:#121a36;       /* 卡片背景 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"SF Pro Display","PingFang SC","Microsoft YaHei UI","Noto Sans CJK SC",system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;color:var(--fg);background:radial-gradient(1200px 800px at 70% 20%, #0f2557 0%, var(--bg) 55%, #070b18 100%);overflow-x:hidden}
    /* 星空 */
    .stars{position:fixed;inset:0;z-index:-2}
    .stars canvas{width:100%;height:100%;display:block}
    /* 月亮 */
    .moon{position:absolute;right:8vw;top:8vh;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff 0%, #fff7d6 40%, #ffeaa7 60%, #ffd166 75%, rgba(255,209,102,.0) 76%);box-shadow:0 0 40px 10px rgba(154,213,255,.45),0 0 160px 40px rgba(255,248,180,.12);filter:saturate(1.05);animation:moonFloat 8s ease-in-out infinite alternate}
    @keyframes moonFloat{to{transform:translateY(-8px)}}
    /* 灯笼 */
    .lantern{position:absolute;width:62px;height:78px;transform-origin:top center;filter:drop-shadow(0 8px 12px rgba(0,0,0,.25));animation:sway 4s ease-in-out infinite}
    .lantern .body{width:100%;height:100%;border-radius:30px/36px;background:linear-gradient(180deg,rgba(255,255,255,.15),rgba(0,0,0,.1)),var(--accent);border:2px solid rgba(255,255,255,.35);box-shadow:inset 0 0 24px rgba(0,0,0,.35)}
    .lantern.orange .body{background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(0,0,0,.1)),var(--accent-2)}
    .lantern .cap,.lantern .tail{height:9px;background:rgba(0,0,0,.2)}
    .lantern .cap{border-radius:10px 10px 0 0}
    .lantern .tail{border-radius:0 0 10px 10px}
    .lantern .line{width:1.5px;height:48px;background:rgba(255,255,255,.4);margin:0 auto}
    .lantern .knot{width:12px;height:12px;border-radius:50%;background:var(--gold);margin:6px auto 0;box-shadow:0 0 12px 3px rgba(255,209,102,.6)}
    .lantern.delay-2{animation-delay:1.2s}
    .lantern.delay-3{animation-delay:2.1s}
    @keyframes sway{0%{transform:rotate(-4deg)}50%{transform:rotate(4deg)}100%{transform:rotate(-4deg)}}
    /* 布局 */
    .wrap{position:relative;min-height:100dvh;padding:12vh 6vw 16vh}
    .card{max-width:880px;margin:0;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:42px 36px;backdrop-filter:blur(6px);box-shadow:0 18px 48px rgba(0,0,0,.35)}
    h1{font-weight:800;line-height:1.1;margin:0 0 14px;font-size:clamp(28px,5vw,46px);letter-spacing:.5px;text-shadow:0 2px 22px rgba(255,255,255,.08)}
    .subtitle{font-size:clamp(16px,2.5vw,20px);opacity:.92;margin-bottom:20px}
    .wish{margin:22px 0 8px;font-size:clamp(18px,3vw,22px);line-height:1.65}
    .poem{margin:10px 0 22px;color:#cfd7ff;opacity:.9;font-size:clamp(14px,2.4vw,16px)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(154,213,255,.12);border:1px solid rgba(154,213,255,.35);color:#d8ecff;margin:10px 0 20px;font-size:14px;letter-spacing:.2px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:24px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:700;color:#0b1024;background:linear-gradient(135deg,#ffe08a,#ffd166);box-shadow:0 8px 16px rgba(255,209,102,.35)}
    .btn.secondary{color:var(--fg);background:linear-gradient(135deg,#2b386b,#1a2146);border:1px solid rgba(255,255,255,.12)}
    .hint{opacity:.8;font-size:13px;margin-top:10px}
    /* 表单/结果 面板 */
    .field{margin:14px 0 10px}
    .field label{display:block;margin:0 0 8px;font-weight:700;letter-spacing:.2px;opacity:.9}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--fg);outline:none}
    .input:focus{border-color:var(--glow);box-shadow:0 0 0 3px rgba(154,213,255,.25)}
    textarea.input{resize:vertical}
    .form-panel .actions .btn{min-width:140px}
    .result-panel .actions .btn{min-width:132px}
    .result-panel[hidden]{display:none}
    /* 特别样式：当姓名为 landing */
    body.special{--accent:#ff85a1;--accent-2:#ffd1dc;--gold:#ffe199}
    body.special .card{border-color:rgba(255,133,161,.35);box-shadow:0 22px 56px rgba(255,133,161,.25)}
    body.special .badge{background:rgba(255,133,161,.12);border-color:rgba(255,133,161,.35)}
    .heart{position:fixed;pointer-events:none;z-index:9999;font-size:18px;opacity:.9;animation:floatUp 2.6s ease-in forwards}
    @keyframes floatUp{to{transform:translateY(-120px) scale(1.4);opacity:0}}
    /* 个人水印（角标） */
    .wm{position:fixed;right:14px;bottom:56px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);color:#cfe7ff;background:rgba(8,16,40,.45);backdrop-filter:blur(4px);font-size:12px;letter-spacing:.3px;z-index:9}
    /* 海报导出优化：固定宽度避免截取抖动 */
    .result-panel.poster{max-width:920px;margin:auto}
    /* 页脚 */
    footer{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;text-align:center;font-size:12px;color:#b9c4ec;opacity:.85}
    /* 小屏优化 */
    @media (max-width:520px){.moon{right:4vw;top:5vh;width:120px;height:120px}.lantern{width:52px;height:66px}.wrap{padding:13vh 4vw 18vh}.card{padding:30px 22px}}
    /* 主题开关控件 */
    .theme-switch{position:fixed;right:14px;top:14px;z-index:10;display:flex;gap:8px;align-items:center;background:rgba(8,16,40,.45);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:12px;color:#d8e7ff;font-size:12px}
    .theme-switch select{appearance:none;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:inherit;padding:6px 8px;border-radius:8px}
    /* 主题：青蓝 */
    body.theme-blue{--bg:#071a29;--fg:#e8f2ff;--glow:#7cc8ff;--card:#0e2236;--accent:#51b8ff;--accent-2:#69d1ff;--gold:#9ad5ff}
    body.theme-blue{background:radial-gradient(1200px 800px at 70% 20%, #0a2d4a 0%, var(--bg) 55%, #05121c 100%)}
    body.theme-blue .badge{background:rgba(124,200,255,.12);border-color:rgba(124,200,255,.35)}
    /* 主题：金粉 */
    body.theme-gold{--bg:#2a0e1a;--fg:#fff2f4;--glow:#ffc7dd;--card:#3a1524;--accent:#ff7b89;--accent-2:#ffb703;--gold:#ffd166}
    body.theme-gold{background:radial-gradient(1200px 800px at 65% 18%, #5b1f33 0%, var(--bg) 55%, #1c0811 100%)}
    body.theme-gold .badge{background:rgba(255,123,137,.12);border-color:rgba(255,123,137,.35)}
  </style>
  <!-- html2canvas 用于生成分享海报 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <!-- 主题选择器 -->
  <div class="theme-switch" aria-label="主题">
    <span>主题</span>
    <select id="themeSelect">
      <option value="default">夜空（默认）</option>
      <option value="blue">青蓝</option>
      <option value="gold">金粉</option>
    </select>
  </div>
  <!-- 星空画布 -->
  <div class="stars"><canvas id="sky"></canvas></div>
  <!-- 装饰：月亮与灯笼 -->
  <div class="moon" aria-hidden="true"></div>
  <div class="lantern" style="left:6vw; top:6vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>
  <div class="lantern orange delay-2" style="left:14vw; top:10vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>
  <div class="lantern delay-3" style="left:22vw; top:5vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>

  <main class="wrap">
    <!-- Step 1：填写信息 -->
    <section class="card form-panel" id="formPanel">
      <span class="badge">📝 Step 1 · 填写祝福信息</span>
      <h1>给好友生成一份中秋祝福</h1>
      <p class="subtitle">填写姓名与祝福语，点击下方按钮生成展示页。</p>

      <div class="field">
        <label for="formName">收件人姓名（可留空表示“大家”）</label>
        <input id="formName" class="input" placeholder="例如：小王；" maxlength="18" />
      </div>
      <div class="field">
        <label for="formMsg">自定义祝福（可选）</label>
        <textarea id="formMsg" class="input" rows="3" placeholder="例如：论文顺利，月饼不胖，凡事顺心！"></textarea>
        <small class="hint">也可用链接参数：<code>?name=小王&msg=论文加油！</code></small>
      </div>

      <div class="actions">
        <button class="btn" id="genBtn">生成祝福</button>
        <button class="btn secondary" id="fillGeneric">通用祝福（给所有人）</button>
      </div>
    </section>

    <!-- Step 2：展示祝福 -->
    <section class="card result-panel" id="resultPanel" hidden>
      <span class="badge">🌕 Step 2 · 祝福展示</span>
      <h1 id="title">中秋快乐，<span id="friend">好朋友</span>！</h1>
      <p class="subtitle" id="subtitle">愿你所盼皆如愿，所行皆坦途，所爱皆可得。</p>
      <p class="wish" id="wishText">🏮 祝你：学业进步、心想事成、身体健康、前程似锦。无论天涯海角，共赏一轮明月。</p>
      <p class="poem" id="poem">“海上生明月，天涯共此时。”——张九龄</p>

      <div class="actions">
        <button class="btn" id="shareBtn">复制祝福链接</button>
        <button class="btn" id="posterBtn">生成分享图（海报）</button>
        <button class="btn secondary" id="switchPoem">换一句诗</button>
        <button class="btn secondary" id="backBtn">返回修改</button>
      </div>

      <div class="hint">  <code> </code>  页面右下角含个人水印与版权标签。</div>
    </section>
  </main>

  <footer>Made with ❤️ for Mid‑Autumn Festival · <span id="year"></span> · © <strong>tgx</strong></footer>
  <div class="wm">© tgx · Personal watermark</div>

  <script>
  // 等待 DOM 完全可用，避免空节点访问
  window.addEventListener('DOMContentLoaded', () => {
    // —— 基础：年份 ——
    document.getElementById('year').textContent = new Date().getFullYear();

    // —— DOM 断言工具（简易测试）——
    function assertEl(id){
      const el = document.getElementById(id);
      if(!el){ throw new Error(`Element #${id} not found`); }
      return el;
    }

    // —— 元素引用（带断言）——
    const formPanel   = assertEl('formPanel');
    const resultPanel = assertEl('resultPanel');
    const formName    = assertEl('formName');
    const formMsg     = assertEl('formMsg');
    const friendSpan  = assertEl('friend');
    const wishEl      = assertEl('wishText');
    const subtitleEl  = assertEl('subtitle');
    const poemEl      = assertEl('poem');
    const genBtn      = assertEl('genBtn');
    const fillGeneric = assertEl('fillGeneric');
    const shareBtn    = assertEl('shareBtn');
    const posterBtn   = assertEl('posterBtn');
    const switchPoem  = assertEl('switchPoem');
    const backBtn     = assertEl('backBtn');

    // 主题选择器
    const themeSelect = document.getElementById('themeSelect');

    // —— 从 URL 读取姓名与自定义祝福 ——
    const params = new URLSearchParams(location.search);
    let friendName = (params.get('name') || '').trim();
    let customMsg  = (params.get('msg')  || '').trim();
    const directView = (params.get('view')||'').toLowerCase()==='show';

    // 主题：读取 URL / 本地持久化并应用
    const urlTheme = (params.get('theme')||'').toLowerCase();
    const savedTheme = window.localStorage.getItem('theme')||'default';
    const initTheme = urlTheme || savedTheme;
    applyTheme(initTheme);
    if(themeSelect){ themeSelect.value = initTheme==='default'? 'default' : initTheme; }
    if(themeSelect){ themeSelect.addEventListener('change', ()=>{ applyTheme(themeSelect.value); }); }
    function applyTheme(key){
      document.body.classList.remove('theme-blue','theme-gold');
      if(key==='blue') document.body.classList.add('theme-blue');
      if(key==='gold') document.body.classList.add('theme-gold');
      window.localStorage.setItem('theme', key||'default');
    }

    // —— UI 应用 ——
    function applyNameUI(name){
      const display = name || '大家';
      friendSpan.textContent = display;
      document.title = `中秋快乐 · 给${display}的祝福`;
      if((name||'').toLowerCase()==='landing') activateSpecial(); else deactivateSpecial();
    }
    function applyMsgUI(msg){
      if(msg){ wishEl.textContent = `🏮 ${msg}`; }
      else{ wishEl.textContent = '🏮 祝你：学业进步、心想事成、身体健康、前程似锦。无论天涯海角，共赏一轮明月。'; }
    }
    function showForm(){ formPanel.hidden=false; resultPanel.hidden=true; }
    function showResult(){ formPanel.hidden=true; resultPanel.hidden=false; }

    // —— 初始化视图 ——
    if(friendName || customMsg || directView){
      formName.value = friendName; formMsg.value = customMsg;
      applyNameUI(friendName); applyMsgUI(customMsg);
      showResult();
    } else {
      showForm();
    }

    // —— 交互：生成祝福 ——
    genBtn.addEventListener('click', () => {
      friendName = (formName.value||'').trim();
      customMsg  = (formMsg.value||'').trim();
      applyNameUI(friendName); applyMsgUI(customMsg); showResult();
    });
    // —— 交互：通用祝福 ——
    fillGeneric.addEventListener('click', () => {
      formName.value=''; formMsg.value='愿大家月圆心圆，阖家安康，万事顺遂！';
      friendName=''; customMsg=formMsg.value; toast('已填入通用祝福');
    });
    // —— 交互：返回修改 ——
    backBtn.addEventListener('click', () => { showForm(); });

    // —— 特殊模式（landing） ——
    function activateSpecial(){
      document.body.classList.add('special');
      subtitleEl.textContent = '愿你的每一个小梦想都被月光温柔照亮。';
      poemEl.textContent = '“愿得一人心，白首不相离。”';
      for(let i=0;i<18;i++) setTimeout(spawnHeart, i*120);
    }
    function deactivateSpecial(){
      document.body.classList.remove('special');
      subtitleEl.textContent = '愿你所盼皆如愿，所行皆坦途，所爱皆可得。';
      poemEl.textContent = '“海上生明月，天涯共此时。”——张九龄';
    }
    function spawnHeart(){
      const h = document.createElement('div');
      h.className='heart';
      h.textContent = ['❤','💖','💗','💓','💞'][Math.floor(Math.random()*5)];
      const x = 60 + Math.random()* (window.innerWidth-120);
      const y = window.innerHeight - 80;
      h.style.left = x+'px'; h.style.top = y+'px';
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 2600);
    }

    // —— 分享链接（含填好的参数）——
    function buildShareUrl(){
      const url = new URL(location.href);
      if(friendName) url.searchParams.set('name', friendName); else url.searchParams.delete('name');
      if(customMsg) url.searchParams.set('msg', customMsg); else url.searchParams.delete('msg');
      url.searchParams.set('view','show');
      const curTheme = (window.localStorage.getItem('theme')||'default');
      if(curTheme && curTheme!=='default') url.searchParams.set('theme', curTheme); else url.searchParams.delete('theme');
      return url.toString();
    }
    shareBtn.addEventListener('click', async () => {
      const urlStr = buildShareUrl();
      try{ await navigator.clipboard.writeText(urlStr); toast('已复制祝福链接'); }
      catch(e){ prompt('复制下面的链接：', urlStr); }
    });

    // —— 生成分享图（海报，含整页背景） ——
    posterBtn.addEventListener('click', async () => {
      if(typeof html2canvas!=='function' && typeof html2canvas!=='object'){ toast('海报组件未加载，请稍后重试'); return; }
      const target = document.body;
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;
      window.scrollTo(0,0);
      try{
        const canvas = await html2canvas(target, {
          backgroundColor: null,
          scale: Math.min(2, window.devicePixelRatio||1),
          x: 0, y: 0, width: vw, height: vh,
          windowWidth: vw, windowHeight: vh,
          useCORS: true
        });
        const ctx = canvas.getContext('2d');
        ctx.save();
        const pad=24; ctx.font='16px system-ui,-apple-system,Segoe UI,PingFang SC,Microsoft YaHei'; ctx.fillStyle='rgba(255,255,255,0.9)';
        const stamp=`© tgx · ${new Date().getFullYear()}`; ctx.fillText(stamp, canvas.width-ctx.measureText(stamp).width-pad, canvas.height-pad);
        ctx.restore();
        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.download = `中秋祝福_${friendName?friendName:'大家'}.png`; a.href=dataUrl; a.click();
        toast('海报已生成（含背景），已开始下载');
      }catch(err){ console.error(err); toast('生成失败：请稍后重试'); }
    });

    // —— 诗句轮换 ——
    const poems = [
      '“但愿人长久，千里共婵娟。”——苏轼',
      '“人有悲欢离合，月有阴晴圆缺。”——苏轼',
      '“举杯邀明月，对影成三人。”——李白',
      '“露从今夜白，月是故乡明。”——杜甫',
      '“长风几万里，吹度玉门关。”——李白'
    ];
    switchPoem.addEventListener('click', ()=>{
      const pick = poems[Math.floor(Math.random()*poems.length)]; poemEl.textContent = pick;
    });

    // —— 简易测试用例（控制台可见）——
    function testCase(name, fn){ try{ fn(); console.log('%c✔ '+name,'color:#7CFC00'); } catch(e){ console.error('✘ '+name, e); toast('用例失败：'+name); } }

    const runTests = (params.get('test')||'')==='1';
    if(runTests){
      testCase('初始：无参数应显示表单', ()=>{ showForm(); if(formPanel.hidden!==false || resultPanel.hidden!==true) throw new Error('显示状态错误'); });
      testCase('展示：带 view=show & name=abc', ()=>{ applyNameUI('abc'); applyMsgUI(''); showResult(); if(friendSpan.textContent!=='abc'||resultPanel.hidden!==false) throw new Error('展示或文案错误'); });
      testCase('特别模式：landing 样式', ()=>{ applyNameUI('landing'); if(!document.body.classList.contains('special')) throw new Error('未进入特殊模式'); });
      // 新增：分享链接应包含 view=show 和 theme 参数（当非默认主题时）
      testCase('分享链接包含参数', ()=>{ window.localStorage.setItem('theme','blue'); const u = buildShareUrl(); if(!u.includes('view=show')) throw new Error('缺少 view=show'); if(!u.includes('theme=blue')) throw new Error('缺少 theme=blue'); window.localStorage.removeItem('theme'); });
      // 新增：showResult 切换隐藏状态
      testCase('showResult 切换面板', ()=>{ showResult(); if(resultPanel.hidden!==false || formPanel.hidden!==true) throw new Error('面板切换失败'); });
    }
  });

  // —— 小提示气泡 ——
  function toast(text){
    const t = document.createElement('div');
    t.textContent = text; t.style.cssText = `position:fixed;left:50%;top:14%;transform:translateX(-50%);padding:10px 16px;z-index:9999;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);color:#fff;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.35);font-size:14px`;
    document.body.appendChild(t); setTimeout(()=>{t.style.transition='all .5s'; t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(-8px)';},1200);
    setTimeout(()=>t.remove(), 1900);
  }

  // —— 星空绘制 ——
  (function starfield(){
    const cvs = document.getElementById('sky');
    const ctx = cvs.getContext('2d');
    let w,h,stars=[];
    function resize(){w = cvs.width = window.innerWidth * devicePixelRatio; h = cvs.height = window.innerHeight * devicePixelRatio;}
    function init(){ stars = []; const count = Math.min(240, Math.floor(w*h/50000)); for(let i=0;i<count;i++){ stars.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.6+0.4,a:Math.random()*1,sp:Math.random()*0.015+0.005}); } }
    function draw(){ ctx.clearRect(0,0,w,h); for(const s of stars){ s.a += s.sp; const alpha = 0.6 + Math.sin(s.a)*0.35; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fillStyle = `rgba(255,255,255,${alpha})`; ctx.fill(); } requestAnimationFrame(draw); }
    window.addEventListener('resize', ()=>{resize(); init();}); resize(); init(); draw();
  })();
  </script>
</body>
</html>
