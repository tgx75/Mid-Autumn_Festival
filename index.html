<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­ç§‹å¿«ä¹ Â· æœˆåœ†äººåœ†</title>
  <meta name="description" content="ç»™æœ‹å‹çš„ä¸­ç§‹èŠ‚ç¥ç¦ç½‘é¡µ" />
  <meta name="theme-color" content="#0b1226" />
  <style>
    :root{
      --bg:#0b1226;         /* å¤œç©ºåº•è‰² */
      --fg:#e6e9f2;         /* æ–‡å­—ä¸»è‰² */
      --gold:#ffd166;       /* é‡‘è‰²ç‚¹ç¼€ */
      --accent:#ff7b89;     /* ç²‰çº¢ç¯ç¬¼ */
      --accent-2:#ffb703;   /* æ©™é»„ç¯ç¬¼ */
      --glow:#9ad5ff;       /* æœˆå…‰ */
      --card:#121a36;       /* å¡ç‰‡èƒŒæ™¯ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"SF Pro Display","PingFang SC","Microsoft YaHei UI","Noto Sans CJK SC",system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;color:var(--fg);background:radial-gradient(1200px 800px at 70% 20%, #0f2557 0%, var(--bg) 55%, #070b18 100%);overflow-x:hidden}
    /* æ˜Ÿç©º */
    .stars{position:fixed;inset:0;z-index:-2}
    .stars canvas{width:100%;height:100%;display:block}
    /* æœˆäº® */
    .moon{position:absolute;right:8vw;top:8vh;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff 0%, #fff7d6 40%, #ffeaa7 60%, #ffd166 75%, rgba(255,209,102,.0) 76%);box-shadow:0 0 40px 10px rgba(154,213,255,.45),0 0 160px 40px rgba(255,248,180,.12);filter:saturate(1.05);animation:moonFloat 8s ease-in-out infinite alternate}
    @keyframes moonFloat{to{transform:translateY(-8px)}}
    /* ç¯ç¬¼ */
    .lantern{position:absolute;width:62px;height:78px;transform-origin:top center;filter:drop-shadow(0 8px 12px rgba(0,0,0,.25));animation:sway 4s ease-in-out infinite}
    .lantern .body{width:100%;height:100%;border-radius:30px/36px;background:linear-gradient(180deg,rgba(255,255,255,.15),rgba(0,0,0,.1)),var(--accent);border:2px solid rgba(255,255,255,.35);box-shadow:inset 0 0 24px rgba(0,0,0,.35)}
    .lantern.orange .body{background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(0,0,0,.1)),var(--accent-2)}
    .lantern .cap,.lantern .tail{height:9px;background:rgba(0,0,0,.2)}
    .lantern .cap{border-radius:10px 10px 0 0}
    .lantern .tail{border-radius:0 0 10px 10px}
    .lantern .line{width:1.5px;height:48px;background:rgba(255,255,255,.4);margin:0 auto}
    .lantern .knot{width:12px;height:12px;border-radius:50%;background:var(--gold);margin:6px auto 0;box-shadow:0 0 12px 3px rgba(255,209,102,.6)}
    .lantern.delay-2{animation-delay:1.2s}
    .lantern.delay-3{animation-delay:2.1s}
    @keyframes sway{0%{transform:rotate(-4deg)}50%{transform:rotate(4deg)}100%{transform:rotate(-4deg)}}
    /* å¸ƒå±€ */
    .wrap{position:relative;min-height:100dvh;padding:12vh 6vw 16vh}
    .card{max-width:880px;margin:0;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:42px 36px;backdrop-filter:blur(6px);box-shadow:0 18px 48px rgba(0,0,0,.35)}
    h1{font-weight:800;line-height:1.1;margin:0 0 14px;font-size:clamp(28px,5vw,46px);letter-spacing:.5px;text-shadow:0 2px 22px rgba(255,255,255,.08)}
    .subtitle{font-size:clamp(16px,2.5vw,20px);opacity:.92;margin-bottom:20px}
    .wish{margin:22px 0 8px;font-size:clamp(18px,3vw,22px);line-height:1.65}
    .poem{margin:10px 0 22px;color:#cfd7ff;opacity:.9;font-size:clamp(14px,2.4vw,16px)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(154,213,255,.12);border:1px solid rgba(154,213,255,.35);color:#d8ecff;margin:10px 0 20px;font-size:14px;letter-spacing:.2px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:24px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:700;color:#0b1024;background:linear-gradient(135deg,#ffe08a,#ffd166);box-shadow:0 8px 16px rgba(255,209,102,.35)}
    .btn.secondary{color:var(--fg);background:linear-gradient(135deg,#2b386b,#1a2146);border:1px solid rgba(255,255,255,.12)}
    .hint{opacity:.8;font-size:13px;margin-top:10px}
    /* è¡¨å•/ç»“æœ é¢æ¿ */
    .field{margin:14px 0 10px}
    .field label{display:block;margin:0 0 8px;font-weight:700;letter-spacing:.2px;opacity:.9}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--fg);outline:none}
    .input:focus{border-color:var(--glow);box-shadow:0 0 0 3px rgba(154,213,255,.25)}
    textarea.input{resize:vertical}
    .form-panel .actions .btn{min-width:140px}
    .result-panel .actions .btn{min-width:132px}
    .result-panel[hidden]{display:none}
    /* ç‰¹åˆ«æ ·å¼ï¼šå½“å§“åä¸º landing */
    body.special{--accent:#ff85a1;--accent-2:#ffd1dc;--gold:#ffe199}
    body.special .card{border-color:rgba(255,133,161,.35);box-shadow:0 22px 56px rgba(255,133,161,.25)}
    body.special .badge{background:rgba(255,133,161,.12);border-color:rgba(255,133,161,.35)}
    .heart{position:fixed;pointer-events:none;z-index:9999;font-size:18px;opacity:.9;animation:floatUp 2.6s ease-in forwards}
    @keyframes floatUp{to{transform:translateY(-120px) scale(1.4);opacity:0}}
    /* ä¸ªäººæ°´å°ï¼ˆè§’æ ‡ï¼‰ */
    .wm{position:fixed;right:14px;bottom:56px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);color:#cfe7ff;background:rgba(8,16,40,.45);backdrop-filter:blur(4px);font-size:12px;letter-spacing:.3px;z-index:9}
    /* æµ·æŠ¥å¯¼å‡ºä¼˜åŒ–ï¼šå›ºå®šå®½åº¦é¿å…æˆªå–æŠ–åŠ¨ */
    .result-panel.poster{max-width:920px;margin:auto}
    /* é¡µè„š */
    footer{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;text-align:center;font-size:12px;color:#b9c4ec;opacity:.85}
    /* å°å±ä¼˜åŒ– */
    @media (max-width:520px){.moon{right:4vw;top:5vh;width:120px;height:120px}.lantern{width:52px;height:66px}.wrap{padding:13vh 4vw 18vh}.card{padding:30px 22px}}
    /* ä¸»é¢˜å¼€å…³æ§ä»¶ */
    .theme-switch{position:fixed;right:14px;top:14px;z-index:10;display:flex;gap:8px;align-items:center;background:rgba(8,16,40,.45);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:12px;color:#d8e7ff;font-size:12px}
    .theme-switch select{appearance:none;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:inherit;padding:6px 8px;border-radius:8px}
    /* ä¸»é¢˜ï¼šé’è“ */
    body.theme-blue{--bg:#071a29;--fg:#e8f2ff;--glow:#7cc8ff;--card:#0e2236;--accent:#51b8ff;--accent-2:#69d1ff;--gold:#9ad5ff}
    body.theme-blue{background:radial-gradient(1200px 800px at 70% 20%, #0a2d4a 0%, var(--bg) 55%, #05121c 100%)}
    body.theme-blue .badge{background:rgba(124,200,255,.12);border-color:rgba(124,200,255,.35)}
    /* ä¸»é¢˜ï¼šé‡‘ç²‰ */
    body.theme-gold{--bg:#2a0e1a;--fg:#fff2f4;--glow:#ffc7dd;--card:#3a1524;--accent:#ff7b89;--accent-2:#ffb703;--gold:#ffd166}
    body.theme-gold{background:radial-gradient(1200px 800px at 65% 18%, #5b1f33 0%, var(--bg) 55%, #1c0811 100%)}
    body.theme-gold .badge{background:rgba(255,123,137,.12);border-color:rgba(255,123,137,.35)}
  </style>
  <!-- html2canvas ç”¨äºç”Ÿæˆåˆ†äº«æµ·æŠ¥ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <!-- ä¸»é¢˜é€‰æ‹©å™¨ -->
  <div class="theme-switch" aria-label="ä¸»é¢˜">
    <span>ä¸»é¢˜</span>
    <select id="themeSelect">
      <option value="default">å¤œç©ºï¼ˆé»˜è®¤ï¼‰</option>
      <option value="blue">é’è“</option>
      <option value="gold">é‡‘ç²‰</option>
    </select>
  </div>
  <!-- æ˜Ÿç©ºç”»å¸ƒ -->
  <div class="stars"><canvas id="sky"></canvas></div>
  <!-- è£…é¥°ï¼šæœˆäº®ä¸ç¯ç¬¼ -->
  <div class="moon" aria-hidden="true"></div>
  <div class="lantern" style="left:6vw; top:6vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>
  <div class="lantern orange delay-2" style="left:14vw; top:10vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>
  <div class="lantern delay-3" style="left:22vw; top:5vh"><div class="line"></div><div class="cap"></div><div class="body"></div><div class="tail"></div><div class="knot"></div></div>

  <main class="wrap">
    <!-- Step 1ï¼šå¡«å†™ä¿¡æ¯ -->
    <section class="card form-panel" id="formPanel">
      <span class="badge">ğŸ“ Step 1 Â· å¡«å†™ç¥ç¦ä¿¡æ¯</span>
      <h1>ç»™å¥½å‹ç”Ÿæˆä¸€ä»½ä¸­ç§‹ç¥ç¦</h1>
      <p class="subtitle">å¡«å†™å§“åä¸ç¥ç¦è¯­ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆå±•ç¤ºé¡µã€‚</p>

      <div class="field">
        <label for="formName">æ”¶ä»¶äººå§“åï¼ˆå¯ç•™ç©ºè¡¨ç¤ºâ€œå¤§å®¶â€ï¼‰</label>
        <input id="formName" class="input" placeholder="ä¾‹å¦‚ï¼šå°ç‹ï¼›" maxlength="18" />
      </div>
      <div class="field">
        <label for="formMsg">è‡ªå®šä¹‰ç¥ç¦ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="formMsg" class="input" rows="3" placeholder="ä¾‹å¦‚ï¼šè®ºæ–‡é¡ºåˆ©ï¼Œæœˆé¥¼ä¸èƒ–ï¼Œå‡¡äº‹é¡ºå¿ƒï¼"></textarea>
        <small class="hint">ä¹Ÿå¯ç”¨é“¾æ¥å‚æ•°ï¼š<code>?name=å°ç‹&msg=è®ºæ–‡åŠ æ²¹ï¼</code></small>
      </div>

      <div class="actions">
        <button class="btn" id="genBtn">ç”Ÿæˆç¥ç¦</button>
        <button class="btn secondary" id="fillGeneric">é€šç”¨ç¥ç¦ï¼ˆç»™æ‰€æœ‰äººï¼‰</button>
      </div>
    </section>

    <!-- Step 2ï¼šå±•ç¤ºç¥ç¦ -->
    <section class="card result-panel" id="resultPanel" hidden>
      <span class="badge">ğŸŒ• Step 2 Â· ç¥ç¦å±•ç¤º</span>
      <h1 id="title">ä¸­ç§‹å¿«ä¹ï¼Œ<span id="friend">å¥½æœ‹å‹</span>ï¼</h1>
      <p class="subtitle" id="subtitle">æ„¿ä½ æ‰€ç›¼çš†å¦‚æ„¿ï¼Œæ‰€è¡Œçš†å¦é€”ï¼Œæ‰€çˆ±çš†å¯å¾—ã€‚</p>
      <p class="wish" id="wishText">ğŸ® ç¥ä½ ï¼šå­¦ä¸šè¿›æ­¥ã€å¿ƒæƒ³äº‹æˆã€èº«ä½“å¥åº·ã€å‰ç¨‹ä¼¼é”¦ã€‚æ— è®ºå¤©æ¶¯æµ·è§’ï¼Œå…±èµä¸€è½®æ˜æœˆã€‚</p>
      <p class="poem" id="poem">â€œæµ·ä¸Šç”Ÿæ˜æœˆï¼Œå¤©æ¶¯å…±æ­¤æ—¶ã€‚â€â€”â€”å¼ ä¹é¾„</p>

      <div class="actions">
        <button class="btn" id="shareBtn">å¤åˆ¶ç¥ç¦é“¾æ¥</button>
        <button class="btn" id="posterBtn">ç”Ÿæˆåˆ†äº«å›¾ï¼ˆæµ·æŠ¥ï¼‰</button>
        <button class="btn secondary" id="switchPoem">æ¢ä¸€å¥è¯—</button>
        <button class="btn secondary" id="backBtn">è¿”å›ä¿®æ”¹</button>
      </div>

      <div class="hint">  <code> </code>  é¡µé¢å³ä¸‹è§’å«ä¸ªäººæ°´å°ä¸ç‰ˆæƒæ ‡ç­¾ã€‚</div>
    </section>
  </main>

  <footer>Made with â¤ï¸ for Midâ€‘Autumn Festival Â· <span id="year"></span> Â· Â© <strong>tgx</strong></footer>
  <div class="wm">Â© tgx Â· Personal watermark</div>

  <script>
  // ç­‰å¾… DOM å®Œå…¨å¯ç”¨ï¼Œé¿å…ç©ºèŠ‚ç‚¹è®¿é—®
  window.addEventListener('DOMContentLoaded', () => {
    // â€”â€” åŸºç¡€ï¼šå¹´ä»½ â€”â€”
    document.getElementById('year').textContent = new Date().getFullYear();

    // â€”â€” DOM æ–­è¨€å·¥å…·ï¼ˆç®€æ˜“æµ‹è¯•ï¼‰â€”â€”
    function assertEl(id){
      const el = document.getElementById(id);
      if(!el){ throw new Error(`Element #${id} not found`); }
      return el;
    }

    // â€”â€” å…ƒç´ å¼•ç”¨ï¼ˆå¸¦æ–­è¨€ï¼‰â€”â€”
    const formPanel   = assertEl('formPanel');
    const resultPanel = assertEl('resultPanel');
    const formName    = assertEl('formName');
    const formMsg     = assertEl('formMsg');
    const friendSpan  = assertEl('friend');
    const wishEl      = assertEl('wishText');
    const subtitleEl  = assertEl('subtitle');
    const poemEl      = assertEl('poem');
    const genBtn      = assertEl('genBtn');
    const fillGeneric = assertEl('fillGeneric');
    const shareBtn    = assertEl('shareBtn');
    const posterBtn   = assertEl('posterBtn');
    const switchPoem  = assertEl('switchPoem');
    const backBtn     = assertEl('backBtn');

    // ä¸»é¢˜é€‰æ‹©å™¨
    const themeSelect = document.getElementById('themeSelect');

    // â€”â€” ä» URL è¯»å–å§“åä¸è‡ªå®šä¹‰ç¥ç¦ â€”â€”
    const params = new URLSearchParams(location.search);
    let friendName = (params.get('name') || '').trim();
    let customMsg  = (params.get('msg')  || '').trim();
    const directView = (params.get('view')||'').toLowerCase()==='show';

    // ä¸»é¢˜ï¼šè¯»å– URL / æœ¬åœ°æŒä¹…åŒ–å¹¶åº”ç”¨
    const urlTheme = (params.get('theme')||'').toLowerCase();
    const savedTheme = window.localStorage.getItem('theme')||'default';
    const initTheme = urlTheme || savedTheme;
    applyTheme(initTheme);
    if(themeSelect){ themeSelect.value = initTheme==='default'? 'default' : initTheme; }
    if(themeSelect){ themeSelect.addEventListener('change', ()=>{ applyTheme(themeSelect.value); }); }
    function applyTheme(key){
      document.body.classList.remove('theme-blue','theme-gold');
      if(key==='blue') document.body.classList.add('theme-blue');
      if(key==='gold') document.body.classList.add('theme-gold');
      window.localStorage.setItem('theme', key||'default');
    }

    // â€”â€” UI åº”ç”¨ â€”â€”
    function applyNameUI(name){
      const display = name || 'å¤§å®¶';
      friendSpan.textContent = display;
      document.title = `ä¸­ç§‹å¿«ä¹ Â· ç»™${display}çš„ç¥ç¦`;
      if((name||'').toLowerCase()==='landing') activateSpecial(); else deactivateSpecial();
    }
    function applyMsgUI(msg){
      if(msg){ wishEl.textContent = `ğŸ® ${msg}`; }
      else{ wishEl.textContent = 'ğŸ® ç¥ä½ ï¼šå­¦ä¸šè¿›æ­¥ã€å¿ƒæƒ³äº‹æˆã€èº«ä½“å¥åº·ã€å‰ç¨‹ä¼¼é”¦ã€‚æ— è®ºå¤©æ¶¯æµ·è§’ï¼Œå…±èµä¸€è½®æ˜æœˆã€‚'; }
    }
    function showForm(){ formPanel.hidden=false; resultPanel.hidden=true; }
    function showResult(){ formPanel.hidden=true; resultPanel.hidden=false; }

    // â€”â€” åˆå§‹åŒ–è§†å›¾ â€”â€”
    if(friendName || customMsg || directView){
      formName.value = friendName; formMsg.value = customMsg;
      applyNameUI(friendName); applyMsgUI(customMsg);
      showResult();
    } else {
      showForm();
    }

    // â€”â€” äº¤äº’ï¼šç”Ÿæˆç¥ç¦ â€”â€”
    genBtn.addEventListener('click', () => {
      friendName = (formName.value||'').trim();
      customMsg  = (formMsg.value||'').trim();
      applyNameUI(friendName); applyMsgUI(customMsg); showResult();
    });
    // â€”â€” äº¤äº’ï¼šé€šç”¨ç¥ç¦ â€”â€”
    fillGeneric.addEventListener('click', () => {
      formName.value=''; formMsg.value='æ„¿å¤§å®¶æœˆåœ†å¿ƒåœ†ï¼Œé˜–å®¶å®‰åº·ï¼Œä¸‡äº‹é¡ºé‚ï¼';
      friendName=''; customMsg=formMsg.value; toast('å·²å¡«å…¥é€šç”¨ç¥ç¦');
    });
    // â€”â€” äº¤äº’ï¼šè¿”å›ä¿®æ”¹ â€”â€”
    backBtn.addEventListener('click', () => { showForm(); });

    // â€”â€” ç‰¹æ®Šæ¨¡å¼ï¼ˆlandingï¼‰ â€”â€”
    function activateSpecial(){
      document.body.classList.add('special');
      subtitleEl.textContent = 'æ„¿ä½ çš„æ¯ä¸€ä¸ªå°æ¢¦æƒ³éƒ½è¢«æœˆå…‰æ¸©æŸ”ç…§äº®ã€‚';
      poemEl.textContent = 'â€œæ„¿å¾—ä¸€äººå¿ƒï¼Œç™½é¦–ä¸ç›¸ç¦»ã€‚â€';
      for(let i=0;i<18;i++) setTimeout(spawnHeart, i*120);
    }
    function deactivateSpecial(){
      document.body.classList.remove('special');
      subtitleEl.textContent = 'æ„¿ä½ æ‰€ç›¼çš†å¦‚æ„¿ï¼Œæ‰€è¡Œçš†å¦é€”ï¼Œæ‰€çˆ±çš†å¯å¾—ã€‚';
      poemEl.textContent = 'â€œæµ·ä¸Šç”Ÿæ˜æœˆï¼Œå¤©æ¶¯å…±æ­¤æ—¶ã€‚â€â€”â€”å¼ ä¹é¾„';
    }
    function spawnHeart(){
      const h = document.createElement('div');
      h.className='heart';
      h.textContent = ['â¤','ğŸ’–','ğŸ’—','ğŸ’“','ğŸ’'][Math.floor(Math.random()*5)];
      const x = 60 + Math.random()* (window.innerWidth-120);
      const y = window.innerHeight - 80;
      h.style.left = x+'px'; h.style.top = y+'px';
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 2600);
    }

    // â€”â€” åˆ†äº«é“¾æ¥ï¼ˆå«å¡«å¥½çš„å‚æ•°ï¼‰â€”â€”
    function buildShareUrl(){
      const url = new URL(location.href);
      if(friendName) url.searchParams.set('name', friendName); else url.searchParams.delete('name');
      if(customMsg) url.searchParams.set('msg', customMsg); else url.searchParams.delete('msg');
      url.searchParams.set('view','show');
      const curTheme = (window.localStorage.getItem('theme')||'default');
      if(curTheme && curTheme!=='default') url.searchParams.set('theme', curTheme); else url.searchParams.delete('theme');
      return url.toString();
    }
    shareBtn.addEventListener('click', async () => {
      const urlStr = buildShareUrl();
      try{ await navigator.clipboard.writeText(urlStr); toast('å·²å¤åˆ¶ç¥ç¦é“¾æ¥'); }
      catch(e){ prompt('å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼š', urlStr); }
    });

    // â€”â€” ç”Ÿæˆåˆ†äº«å›¾ï¼ˆæµ·æŠ¥ï¼Œå«æ•´é¡µèƒŒæ™¯ï¼‰ â€”â€”
    posterBtn.addEventListener('click', async () => {
      if(typeof html2canvas!=='function' && typeof html2canvas!=='object'){ toast('æµ·æŠ¥ç»„ä»¶æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•'); return; }
      const target = document.body;
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;
      window.scrollTo(0,0);
      try{
        const canvas = await html2canvas(target, {
          backgroundColor: null,
          scale: Math.min(2, window.devicePixelRatio||1),
          x: 0, y: 0, width: vw, height: vh,
          windowWidth: vw, windowHeight: vh,
          useCORS: true
        });
        const ctx = canvas.getContext('2d');
        ctx.save();
        const pad=24; ctx.font='16px system-ui,-apple-system,Segoe UI,PingFang SC,Microsoft YaHei'; ctx.fillStyle='rgba(255,255,255,0.9)';
        const stamp=`Â© tgx Â· ${new Date().getFullYear()}`; ctx.fillText(stamp, canvas.width-ctx.measureText(stamp).width-pad, canvas.height-pad);
        ctx.restore();
        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.download = `ä¸­ç§‹ç¥ç¦_${friendName?friendName:'å¤§å®¶'}.png`; a.href=dataUrl; a.click();
        toast('æµ·æŠ¥å·²ç”Ÿæˆï¼ˆå«èƒŒæ™¯ï¼‰ï¼Œå·²å¼€å§‹ä¸‹è½½');
      }catch(err){ console.error(err); toast('ç”Ÿæˆå¤±è´¥ï¼šè¯·ç¨åé‡è¯•'); }
    });

    // â€”â€” è¯—å¥è½®æ¢ â€”â€”
    const poems = [
      'â€œä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚â€â€”â€”è‹è½¼',
      'â€œäººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºã€‚â€â€”â€”è‹è½¼',
      'â€œä¸¾æ¯é‚€æ˜æœˆï¼Œå¯¹å½±æˆä¸‰äººã€‚â€â€”â€”æç™½',
      'â€œéœ²ä»ä»Šå¤œç™½ï¼Œæœˆæ˜¯æ•…ä¹¡æ˜ã€‚â€â€”â€”æœç”«',
      'â€œé•¿é£å‡ ä¸‡é‡Œï¼Œå¹åº¦ç‰é—¨å…³ã€‚â€â€”â€”æç™½'
    ];
    switchPoem.addEventListener('click', ()=>{
      const pick = poems[Math.floor(Math.random()*poems.length)]; poemEl.textContent = pick;
    });

    // â€”â€” ç®€æ˜“æµ‹è¯•ç”¨ä¾‹ï¼ˆæ§åˆ¶å°å¯è§ï¼‰â€”â€”
    function testCase(name, fn){ try{ fn(); console.log('%câœ” '+name,'color:#7CFC00'); } catch(e){ console.error('âœ˜ '+name, e); toast('ç”¨ä¾‹å¤±è´¥ï¼š'+name); } }

    const runTests = (params.get('test')||'')==='1';
    if(runTests){
      testCase('åˆå§‹ï¼šæ— å‚æ•°åº”æ˜¾ç¤ºè¡¨å•', ()=>{ showForm(); if(formPanel.hidden!==false || resultPanel.hidden!==true) throw new Error('æ˜¾ç¤ºçŠ¶æ€é”™è¯¯'); });
      testCase('å±•ç¤ºï¼šå¸¦ view=show & name=abc', ()=>{ applyNameUI('abc'); applyMsgUI(''); showResult(); if(friendSpan.textContent!=='abc'||resultPanel.hidden!==false) throw new Error('å±•ç¤ºæˆ–æ–‡æ¡ˆé”™è¯¯'); });
      testCase('ç‰¹åˆ«æ¨¡å¼ï¼šlanding æ ·å¼', ()=>{ applyNameUI('landing'); if(!document.body.classList.contains('special')) throw new Error('æœªè¿›å…¥ç‰¹æ®Šæ¨¡å¼'); });
      // æ–°å¢ï¼šåˆ†äº«é“¾æ¥åº”åŒ…å« view=show å’Œ theme å‚æ•°ï¼ˆå½“éé»˜è®¤ä¸»é¢˜æ—¶ï¼‰
      testCase('åˆ†äº«é“¾æ¥åŒ…å«å‚æ•°', ()=>{ window.localStorage.setItem('theme','blue'); const u = buildShareUrl(); if(!u.includes('view=show')) throw new Error('ç¼ºå°‘ view=show'); if(!u.includes('theme=blue')) throw new Error('ç¼ºå°‘ theme=blue'); window.localStorage.removeItem('theme'); });
      // æ–°å¢ï¼šshowResult åˆ‡æ¢éšè—çŠ¶æ€
      testCase('showResult åˆ‡æ¢é¢æ¿', ()=>{ showResult(); if(resultPanel.hidden!==false || formPanel.hidden!==true) throw new Error('é¢æ¿åˆ‡æ¢å¤±è´¥'); });
    }
  });

  // â€”â€” å°æç¤ºæ°”æ³¡ â€”â€”
  function toast(text){
    const t = document.createElement('div');
    t.textContent = text; t.style.cssText = `position:fixed;left:50%;top:14%;transform:translateX(-50%);padding:10px 16px;z-index:9999;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);color:#fff;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.35);font-size:14px`;
    document.body.appendChild(t); setTimeout(()=>{t.style.transition='all .5s'; t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(-8px)';},1200);
    setTimeout(()=>t.remove(), 1900);
  }

  // â€”â€” æ˜Ÿç©ºç»˜åˆ¶ â€”â€”
  (function starfield(){
    const cvs = document.getElementById('sky');
    const ctx = cvs.getContext('2d');
    let w,h,stars=[];
    function resize(){w = cvs.width = window.innerWidth * devicePixelRatio; h = cvs.height = window.innerHeight * devicePixelRatio;}
    function init(){ stars = []; const count = Math.min(240, Math.floor(w*h/50000)); for(let i=0;i<count;i++){ stars.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.6+0.4,a:Math.random()*1,sp:Math.random()*0.015+0.005}); } }
    function draw(){ ctx.clearRect(0,0,w,h); for(const s of stars){ s.a += s.sp; const alpha = 0.6 + Math.sin(s.a)*0.35; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fillStyle = `rgba(255,255,255,${alpha})`; ctx.fill(); } requestAnimationFrame(draw); }
    window.addEventListener('resize', ()=>{resize(); init();}); resize(); init(); draw();
  })();
  </script>
</body>
</html>
